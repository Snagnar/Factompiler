# ============================================================
# HSV Color Cycling Lamp Array
# ============================================================
# ============================================================
# Helper function to place a colored lamp
# ============================================================
func place_colored_lamp(x, y, red, green, blue) {
    Entity lamp = place("small-lamp", x, y, {use_colors: 1, always_on: 1, color_mode: 1});
    lamp.r = red;
    lamp.g = green;
    lamp.b = blue;
    return lamp;
}

Signal step_size = 1;  # Change this value to adjust speed (1=fastest, higher=slower)

Memory hue: "signal-H";
# 1530 = 6 * 255 to cover full HSV cycle in finer steps
write((read(hue) + step_size) % 1530, hue);

# ============================================================
# HSV to RGB Conversion (with S=1, V=1 always)
# ============================================================
# When S=V=1, the conversion simplifies to 6 sectors:
#   Sector 0 (H:0-59):   R=255, G=rising,  B=0
#   Sector 1 (H:60-119): R=falling, G=255, B=0
#   Sector 2 (H:120-179): R=0, G=255, B=rising
#   Sector 3 (H:180-239): R=0, G=falling, B=255
#   Sector 4 (H:240-299): R=rising, G=0, B=255
#   Sector 5 (H:300-359): R=255, G=0, B=falling
# ============================================================

Signal h = read(hue);

# Calculate sector (0-5) and position within sector (0-254)
Signal sector = h / 255;
Signal position = h % 255;

# Rising goes 0→254, falling goes 255→1
Signal rising = position;
Signal falling = 255 - position;

# Sector detection signals
Signal in_s0 = sector == 0;
Signal in_s1 = sector == 1;
Signal in_s2 = sector == 2;
Signal in_s3 = sector == 3;
Signal in_s4 = sector == 4;
Signal in_s5 = sector == 5;

# Calculate RGB values
Signal red_val = (in_s0 * 255) 
              + (in_s1 * falling) 
              + (in_s4 * rising) 
              + (in_s5 * 255);

Signal green_val = (in_s0 * rising) 
                 + (in_s1 * 255) 
                 + (in_s2 * 255) 
                 + (in_s3 * falling);

Signal blue_val = (in_s2 * rising) 
                + (in_s3 * 255) 
                + (in_s4 * 255) 
                + (in_s5 * falling);

# ============================================================
# Project to Factorio Color Signals
# ============================================================
Signal r = red_val | "signal-red";
Signal g = green_val | "signal-green";
Signal b = blue_val | "signal-blue";

# ============================================================
# Place 5x5 Lamp Grid (25 lamps)
# All lamps have use_colors enabled for RGB control
# ============================================================

# Row 0
Entity lamp_00 = place_colored_lamp(0, 0, r, g, b);
Entity lamp_01 = place_colored_lamp(1, 0, r, g, b);
Entity lamp_02 = place_colored_lamp(2, 0, r, g, b);
Entity lamp_03 = place_colored_lamp(3, 0, r, g, b);
Entity lamp_04 = place_colored_lamp(4, 0, r, g, b);

# Row 1
Entity lamp_10 = place_colored_lamp(0, 1, r, g, b);
Entity lamp_11 = place_colored_lamp(1, 1, r, g, b);
Entity lamp_12 = place_colored_lamp(2, 1, r, g, b);
Entity lamp_13 = place_colored_lamp(3, 1, r, g, b);
Entity lamp_14 = place_colored_lamp(4, 1, r, g, b);

# Row 2
Entity lamp_20 = place_colored_lamp(0, 2, r, g, b);
Entity lamp_21 = place_colored_lamp(1, 2, r, g, b);
Entity lamp_22 = place_colored_lamp(2, 2, r, g, b);
Entity lamp_23 = place_colored_lamp(3, 2, r, g, b);
Entity lamp_24 = place_colored_lamp(4, 2, r, g, b);

# Row 3
Entity lamp_30 = place_colored_lamp(0, 3, r, g, b);
Entity lamp_31 = place_colored_lamp(1, 3, r, g, b);
Entity lamp_32 = place_colored_lamp(2, 3, r, g, b);
Entity lamp_33 = place_colored_lamp(3, 3, r, g, b);
Entity lamp_34 = place_colored_lamp(4, 3, r, g, b);

# Row 4
Entity lamp_40 = place_colored_lamp(0, 4, r, g, b);
Entity lamp_41 = place_colored_lamp(1, 4, r, g, b);
Entity lamp_42 = place_colored_lamp(2, 4, r, g, b);
Entity lamp_43 = place_colored_lamp(3, 4, r, g, b);
Entity lamp_44 = place_colored_lamp(4, 4, r, g, b);
