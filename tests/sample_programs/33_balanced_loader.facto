# ============================================================
# Balanced Chest Loader/Unloader (4 chests)
# Uses MadZuri pattern for perfectly even item distribution
# ============================================================
#
# LAYOUT:
#   y = -2  : Input belts (items arrive here)
#   y = -1  : Loading inserters (belt → chest)
#   y = 0   : Steel chests
#   y = 1   : Unloading inserters (chest → belt)
#   y = 2   : Output belts (items leave here)
#
# ============================================================

int NUM_CHESTS = 4;

# === INPUT BELTS (items flow east along this row) ===
for x in 0..NUM_CHESTS {
    Entity belt = place("transport-belt", x, -2, {direction: 4});
}

# === OUTPUT BELTS (items flow east along this row) ===
for x in 0..NUM_CHESTS {
    Entity belt = place("transport-belt", x, 2, {direction: 4});
}

# === CHESTS ===
Entity chest1 = place("steel-chest", 0, 0);
Entity chest2 = place("steel-chest", 1, 0);
Entity chest3 = place("steel-chest", 2, 0);
Entity chest4 = place("steel-chest", 3, 0);

# === CIRCUIT LOGIC (MadZuri Pattern) ===

# Step 1: Sum all chest contents via wire merge
Bundle total = {chest1.output, chest2.output, chest3.output, chest4.output};

# Step 2: Compute negative average (divide by -N)
Bundle neg_avg = total / -NUM_CHESTS;

# Step 3: For each chest, compute (contents - average)
Bundle diff1 = {neg_avg, chest1.output};
Bundle diff2 = {neg_avg, chest2.output};
Bundle diff3 = {neg_avg, chest3.output};
Bundle diff4 = {neg_avg, chest4.output};

# === LOADING INSERTERS (direction 8 = SOUTH: picks from north/belt, drops to south/chest) ===
Entity load1 = place("fast-inserter", 0, -1, {direction: 0});
Entity load2 = place("fast-inserter", 1, -1, {direction: 0});
Entity load3 = place("fast-inserter", 2, -1, {direction: 0});
Entity load4 = place("fast-inserter", 3, -1, {direction: 0});

# Enable loading when chest is BELOW average (needs more items)
# Using all() so that empty chests (no signals) are vacuously TRUE and get loaded
load1.enable = all(diff1) < 0;
load2.enable = all(diff2) < 0;
load3.enable = all(diff3) < 0;
load4.enable = all(diff4) < 0;

# === UNLOADING INSERTERS (direction 8 = SOUTH: picks from north/chest, drops to south/belt) ===
Entity unload1 = place("fast-inserter", 0, 1, {direction: 0});
Entity unload2 = place("fast-inserter", 1, 1, {direction: 0});
Entity unload3 = place("fast-inserter", 2, 1, {direction: 0});
Entity unload4 = place("fast-inserter", 3, 1, {direction: 0});

# Enable unloading when chest is ABOVE average (has excess items)
# Using any() so that empty chests (no signals) are FALSE and don't unload
unload1.enable = any(diff1) > 0;
unload2.enable = any(diff2) > 0;
unload3.enable = any(diff3) > 0;
unload4.enable = any(diff4) > 0;